#!/usr/bin/perl -w

################################################################
#   Program:    Password Reset Request Form                    #
#   Author:     Luis Gustavo Rodriguez (drlouie)               #
#   Copyright:  (c) 2016 Luis G. Rodriguez                     #
#   Licensing:  MIT License                                    #
##################################################################################
# Permission is hereby granted, free of charge, to any person obtaining a copy   #
# of this software and associated documentation files (the "Software"), to deal  #
# in the Software without restriction, including without limitation the rights   #
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell      #
# copies of the Software, and to permit persons to whom the Software is          #
# furnished to do so, subject to the following conditions:                       #
#                                                                                #
# The above copyright notice and this permission notice shall be included in all #
# copies or substantial portions of the Software.                                #
#                                                                                #
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR     #
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,       #
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE    #
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER         #
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,  #
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  #
# SOFTWARE.                                                                      #
##################################################################################

$perlCompileOS = $^O;
if ($perlCompileOS =~ m/Win/i) {
	$HTTPRoot = 'H:/dvwf/rbsd_IO/vhosts/vsnet/htdocsNEW/';
	$invHTTPRoot = 'H:/dvwf/rbsd_IO/vhosts/vsnet/invisibleHTTP/';
}
else {
	$HTTPRoot = '/var/www/vps-net.com/htdocs/';
	$invHTTPRoot = '/var/www/vps-net.com/invisibleHTTP/';
}

$|=1;

$noDateParse = 1;
require($HTTPRoot."dateNewest.nsp");

$ECkey = 'chuiechuie'; ##-> set cookie key for IMVER [only for eyeCaptcha functions]
## --> Snif cookie, if present test for logged in status
require ($HTTPRoot."cookiesnif.nsp");

##--$singleShotQuery = single shot version of query parser, has added function for reading form input with only name as dataset, no value
$singleShotQuery = 1;
require($HTTPRoot."q.nsp");

##--virtual functions
require($HTTPRoot."vfunc.nsp");

use Crypt::Tea_JS;

$PageTitle = "Account Recovery";

#-- 370 262
$backgroundHeight = '370';

##-- 
##-- defeat warnings [Use of uninitialized value]
##-- 
$ISRESET = 0;
$badTry = 0;
$fancyControl = "";
$CaptchaFailed = 0;
$myInformation = '';
$elTHROW = "";
$PD2="";
$shakeP="";
$shakeGUID="";
$shakeUser="";
$decryptuser = "";
##-- 
##-- defeat warnings [used only once: possible typo]
##-- 
$noDateParse = $noDateParse;
$ECkey = $ECkey;
$datetime = $datetime;
$singleShotQuery = $singleShotQuery;
##-- 
##-- done defeating
##-- 



$dirtyOut = "";
$dirtyOut2 = "var virtualPrivate=function(){if (!(!parent.runFancyFancy)) { parent.runFancyFancy('/login.htm','Virtual Private',580,260); }else { document.location.href = '/login.htm'; }};setTimeout(virtualPrivate,15000);";
##-simulate input to stimulate output
if ($FORM{'m'} && $FORM{'u'} && ($FORM{'m'} eq "1")) { 
	$RUNFORM = 1; 
	$passReset = 1;
	$dirtyOut = $dirtyOut2;
	$Username = "$FORM{'u'}";
}
if ($FORM{'m'} && $FORM{'u'} && ($FORM{'m'} eq "2")) { 
	$RUNFORM = 1; 
	$emailSent = 1; 
	$dirtyOut = $dirtyOut2;
	$Username = "$FORM{'u'}";
}


##-- find if our form is from an emailed hash link [has three data parts one:two:three]
##-- counted by finding two 5-20 character strings preceded by :
##-- first character string is a given [later verified for length]
$ctf = 0;$recft='';
if ($Todo_Form[0] && ($Todo_Form[0]=~'-----')){
	while($Todo_Form[0]=~m/:{1,20}/g){$ctf++;}
	if ($ctf == 2) {
		($elCFT,$elTHROW) = split(/-----/,$Todo_Form[0]);
		$recft = "<input type=\"hidden\" name=\"$elCFT\" value=\"1\">";
	}
}



$runClick = 'var hasClicked=0;var runClick=function(quien,action){hasClicked=1;quien.value=action;if(!(!document.getpass.SubmitButton)){document.getpass.SubmitButton.disabled=1;}document.getpass.CancelButton.disabled=1;if(action=="Canceling"||action=="Loading"){if(!(!parent.runFancyFancy)){parent.runFancyFancy("/login.htm","Virtual Private",580,260);}else{document.location.href="/login.htm";}}else{document.getpass.submit();}};';

$RBC = 'var rBc=function(){if(!(!document.getpass.SubmitButton)){document.getpass.SubmitButton.disabled=0;document.getpass.SubmitButton.value="Retrieve Password";}document.getpass.CancelButton.disabled=0;document.getpass.CancelButton.value="Cancel";};'.$runClick.'';

## already has pushed through new passwords (save) {remove and warn of illegal characters, have user try again}
if ($FORM{'pDub'} && $FORM{'pDub2'} && $elCFT) {

	$CaptchaFailed = 9;
	if ($FORM{'Challenge'}) {
		##-- cleaner way
		$CaptchaFailed = &testCaptcha;
	}

	##--must submit challenge code to go into this process point
	if ($CaptchaFailed == 0) {
		$thisUserID = 0;

		## encryption challenge to verify user
		$ISRESET = 1;
		
		&challengeFMP;

		$PD = "$FORM{'pDub'}";
		$PD2 = "$FORM{'pDub2'}";
    
		$badTry = 1;
		$badTry = &checkNewPassword;

		#-$hasChanged = 0;
		#-$badTry = 0;
		#-$tooShort = 0;
		#-$tooLong = 0;
		#-$lengther1 = length($PD);
		#-$fs = '/';$bs = '\';
		#-$PD =~ s/\n//gi; $PD =~ s/%//gi; $PD =~ s/'//gi; $PD =~ s/"//gi; $PD =~ s/$fs//gi; $PD =~ s/$bs//gi; $PD =~ s/=//gi; $PD =~ s/\&//gi; $PD =~ s/\#//gi; $PD =~ s/ //gi;
		#-$lengther2 = length($PD);
		##-->> hasChanged = how many illegal characters removed from original string passed by user [mozilla]
		#-if ($lengther1 != $lengther2) { $hasChanged = ($lengther1 - $lengther2); $badTry = 1; $whyNewTry = "Your password contained $hasChanged <font color='red' title='\\' \" \\ / = \& #'>illegal characters</font>"; }
		#-if ($lengther2 < 8) { $tooShort = 1; $badTry = 1; $whyNewTry = "Your password was too short, minimum 8 characters."; }
		#-if ($lengther2 > 12) { $tooLong = 1; $badTry = 1; $whyNewTry = "Your password was too long, maximum 12 characters."; }
	
		##-->> GOOD SAVE AND ALERT
		if ($badTry == 0) {
		
			if ($thisUserID && (int($thisUserID) >= 555) && $decryptuser =~ "[at]") {
				use DBI;
				my $dbh = DBI->connect("DBI:mysql:vpsnetcom","vpsnetcom","YOUR-MySQL-PASSWORD") or die "No data access: <b>VPS-NET</b>\n"; 
				$dbh->{RaiseError} = 1;
	
				my $sth = $dbh->prepare("SELECT MD5('$PD')");
				$sth->execute or die "Sorry, that Username/Password combination are incorrect, try again at your own risk.\n"; 
				my $row = $sth->fetchrow_arrayref;
				my $elCrypto = $row->[0];
				$sth->finish;
				$elCrypto = substr($elCrypto, 2);

				$sth = $dbh->prepare("UPDATE LOW_PRIORITY Users 
										 SET Password='$elCrypto'
										 WHERE Email='$decryptuser'");
				$sth->execute or die "Unable to execute query\n"; 
				$sth->finish;
				$dbh->disconnect;
			}

			#->WAS
			#->print "Cache-Control: must-revalidate\n";print qq~<script language="javascript">alert('Your password has been successfully changed. You can now log in to the system with your username and new password.');if (!(!parent.runFancyFancy)) { parent.runFancyFancy('/login.htm','Virtual Private',580,260); }else { document.location.href = '/login.htm'; }</script>~;exit;
			
			#$fancyControl = "if (!(!parent.runFancyFancy)) { parent.runFancyFancy('/forgot-my-password.htm?m=1&u=$Username','Virtual Private',580,190); }else { alert('Your password has been successfully changed. You can now log in to the system with your username and new password.'); document.location.href = '/login.htm'; }";
			$RUNFORM = 1;
			$passReset = 1;
		}
		else {
			$ISRESET = 1;
			$RUNFORM = 1;
		}
	}
	##-- re-run form, asking for challenge code
	else {
		$ISRESET = 1;
		$RUNFORM = 1;
	}
}

##--start as clean [only when relative does is get changed in the process]
$UsernameFailed = 0;

## IF WE GET BADTRY ABOVE THEN WE REPARSE FORM WITH SPECIAL INSTRUCTIONS
## link back by user from password request email OR failed pdub change from above
if (($recft ne "") || ($badTry == 1)) {

	## encryption challenge to verify user
	$ISRESET = 1;
	&challengeFMP;
	$RUNFORM = 1;
}
elsif ($FORM{'uNaim'}) {

	$CaptchaFailed = 9;
	if ($FORM{'Challenge'}) {
		##-- cleaner way
		$CaptchaFailed = &testCaptcha;
	}

	##--must submit challenge code to go into this process point
	if ($CaptchaFailed == 0) {
		## Define Variables
		$Username = "$FORM{'uNaim'}";
		
		$UsernameFailed = 1;
		$UsernameFailed = &checkUsername;
		
		if ($UsernameFailed == 0) {
			
			## Start DB connection
			use DBI;
			my $dbh = DBI->connect("DBI:mysql:vpsnetcom","vpsnetcom","YOUR-MySQL-PASSWORD") or die "No data access: <b>VPS-NET</b>\n"; 
			$dbh->{RaiseError} = 1; 
			my $sth = $dbh->prepare("SELECT UserID, FirstName, LastName, Email, Password FROM Users WHERE Username = '$Username'");
			$sth->execute or die "Sorry, that Username/Password combination are incorrect, try again at your own risk.\n"; 
			my $row = $sth->fetchrow_arrayref;
			$UserID = $row->[0];
			$First = $row->[1];
			$Last = $row->[2];
			$Email = $row->[3];
			$CPass = $row->[4];
			$sth->finish;
			$dbh->disconnect;

			if ($UserID && ($UserID > 555)) {

				##--RUN verify link shaker
				$shakeP = $CPass;
				$shakeUser = $Email;
				$shakeGUID = $Username;
				$emailShakenU = &makeVerifyAccountHashFMP;

				$laEME = $Email;
				$laEME =~ s/\[at\]/@/g;

				$myInformation = "<b>About This Message</b><br><br>This message was sent to you by Virtual Private Servers and Networks. to remind you of your password, as per your request.</i>";
				## ----------------------->>> SEND RECIPIENTS'S EMAIL
				## ----------------------->>> PREPARE VARIABLES FOR OUTER SEND EMAIL PROGRAM
				my $OGSenderIn = "Virtual Private - Account Management<admin\@vps-net.com>";
				#-my $OGRecipientIn = "$laEME ( $First $Last )";
				$elEmailTo = "$laEME";

				if ($First && $Last) {
					if ((length($First) > 2) && (length($Last) > 2)) { $elEmailTo = "$First $Last <$laEME>"; }
				}
				my $OGRecipientIn = $elEmailTo;
				my $OGsubject = "Password Retrieval";

				$myEmailBody = &getEmailHTML(2,1,"Virtual Private - $PageTitle","","$OGsubject","Due to the fact that passwords are encrypted heavily when stored in our system, they cannot be retrieved. That's okay though, so long as you always remember your email address, you will always be able to easily reset your password. Now, all you have to do is <a href=\"http://www.vps-net.com/forgot-my-password.htm?$emailShakenU\" class=\"instruct\" target=\"VPS-NET-COM\" title=\"To reset your Virtual Private account password, click this link to head to back to our website.\">click here</a> to return to our site to reset your password.<br><br><i>* Password reset links are only valid for one hour</i><br><br><i>* If you didn't request this information to be sent to you please let us know</i>","Can't see or click the link above? Simply copy and paste this entire URL into your favorite browsers' address bar and hit enter: http://www.vps-net.com/forgot-my-password.htm?$emailShakenU");

				use lib "/usr/local/lib/";
				use MIME::Lite;
				my $msg = MIME::Lite->new(
									From    =>$OGSenderIn,
				                	To      =>$OGRecipientIn,
   		    	 		        	Subject =>$OGsubject,
				                	Type    =>'multipart/related'
	   	     					);
			   	$msg->attach(Type => 'text/html',
			   	Data => $myEmailBody);
				$msg->send();
			}
			$fancyControl = "if (!(!parent.runFancyFancy)) { parent.runFancyFancy('/forgot-my-password.htm?m=2&u=$Username','Virtual Private',580,190); }else { document.location.href = '/forgot-my-password.htm?m=2&u=$Username'; }";
			$RUNFORM = 1;
			$emailSent = 1;
		}
		else {
			$RUNFORM = 1;
		}
		#->WAS
		#->print "Cache-Control: must-revalidate\n\n";print qq~<script language="javascript">alert('If an account exists for $Username, we will send $Username an email message with instructions on resetting the account password.');if (!(!parent.runFancyFancy)) { parent.runFancyFancy('/login.htm','Virtual Private',580,260); }else { document.location.href = '/login.htm'; }</script>~;exit;
	}
	else {
		$RUNFORM = 1;
	}
}
## default -> form
else {
	$RUNFORM = 1;
}




##-- if asking to parse form
if ($RUNFORM == 1) {
	$submitTitle = "Retrieve Password";
	##-- if not yet set [enter username form]
	if ($ISRESET == 0) {
		$FeedbackMessage = "Enter your account username to retrieve your password.<br><br>";
		##-- captcha feedback messages
		if ($CaptchaFailed == 1) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Challenge code was incorrect, please try again: <br><br>'; }
		elsif ($CaptchaFailed == 8) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Challenge code is 6 characters in length, try again: <br><br>'; }
		elsif ($CaptchaFailed == 9) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Challenge code is required, please try again: <br><br>'; }

		##-- captcha feedback messages
		if ($UsernameFailed == 1) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Invalid username entered, please try again: <br><br>'; }
		
		$cualPrompt =  '<div class="welcomeText"><b>Retrieve Account Password</b></div><div class="feedbackMessage">'.$FeedbackMessage.'</div>'; 
		$RBC =~ s/Retrieve Password/$submitTitle/gi;
		$formChecker = ''.$RBC.'';
		$loadscript = "onLoad=\"document.getpass.uNaim.select();document.getpass.uNaim.focus();\"";

	}
	##-- if set [password change form]
	else {

		#-->$PageTitle = "Set New Password";
		$submitTitle = "Save Password";
		$itemTitle = "Reset Your Account Password";
		$itemTitle2 =  'Try Again: Reset Password';	
		
		$FeedbackMessage = 'Type your new password. Must be between 8-12 characters.<br><br>';
		
		##-- captcha feedback messages
		if ($CaptchaFailed == 1) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Challenge code was incorrect, please try again: <br><br>'; $itemTitle = $itemTitle2; }
		elsif ($CaptchaFailed == 8) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Challenge code is 6 characters in length, try again: <br><br>'; $itemTitle = $itemTitle2; }
		elsif ($CaptchaFailed == 9) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Challenge code is required, please try again: <br><br>'; $itemTitle = $itemTitle2; }

		if ($CaptchaFailed == 0) {
			if ($whyNewTry) {
				$itemTitle = $itemTitle2;
				$FeedbackMessage = $whyNewTry . "<br><br>";
			}
		}

		$cualPrompt =  '<div class="welcomeText"><b>'.$itemTitle.'</b></div><div class="feedbackMessage">'.$FeedbackMessage.'</em></div>';
		$RBC =~ s/Retrieve Password/$submitTitle/gi;
		$formChecker = 'var cIp=function(val){var key=window.event.keyCode;var leValue=val.value;if(key==35||key==38||key==61||key==92||key==47||key==39||key==34){window.event.returnValue=null;}else{leValue=val.value;return;}};'.$RBC.'';
		$loadscript = "onLoad=\"document.getpass.pDub.select();document.getpass.pDub.focus();\"";
		$ISRESET = 1;
	}
	
	$onbefore = 'doUnload();';
	##-- no longer using $emailSent [just using alert instead, fluidity]
	if (length($fancyControl) >= 1 || $errorKicker || $passReset || $emailSent) {
		$formChecker = '';
		$onbefore = '';
		$loadscript = '';
		if ($passReset) {
			$kickMessage = "Your password has been successfully changed.<br><br><em>You can now log in to the system with your username and new password.</em>";
			#-->$PageTitle = "Account Password Changed";
			$cualPrompt =  '<div class="welcomeText"><b>New Password Saved</b></div><div class="feedbackMessage">'.$kickMessage.'</em></div>';
		}
		elsif ($emailSent) {
			$kickMessage = "<div style=\"text-align:left;line-height:18px;padding-left:25px;padding-right:25px;\">If an account exists for <b>$Username</b>, we will send <b>$Username</b> an email message with instructions on resetting the account password.</div>";
			#-->$PageTitle = "Password Retrieval Request";
			$cualPrompt =  '<div class="welcomeText"><b>Request Successfully Processed</b></div><div class="feedbackMessage">'.$kickMessage.'</em></div>';
		}
		elsif ($errorKicker) {
			$kickMessage = "You must have copied and pasted a link incorrectly, or simply followed a bad link.<br><br><em>Make sure you copy and paste the password retrieval request link properly.</em><br><br><em style=\"font-size:9px;\">Keep getting this same error? Just submit a new <a href=\"javascript:if(!(!parent.runFancyFancy)){parent.runFancyFancy('/forgot-my-password.htm','Virtual Private',580,370);}else{document.location.href='/forgot-my-password.htm';}\" title=\"Request a new Password Retrieval Request\" class=\"commonHelper\">password retrieval request</a>.</em>";
			if ($errorKicker == 3) { $kickMessage = "The password retrieval request link you have followed has expired.<br><br><em>Password retrieval request links are only good for one hour.</em><br><br><em style=\"font-size:9px;\">You can always submit another <a href=\"javascript:if(!(!parent.runFancyFancy)){parent.runFancyFancy('/forgot-my-password.htm','Virtual Private',580,370);}else{document.location.href='/forgot-my-password.htm';}\" title=\"Request a new Password Retrieval Request\" class=\"commonHelper\">password retrieval request</a>.</em>"; }

			if ($whyNewTry) { $kickMessage .= $whyNewTry; }

			#-->$PageTitle = "User Verification Error";
			$cualPrompt =  '<div class="welcomeText"><b>User Verification Failed</b></div><div class="feedbackMessage">'.$kickMessage.'</em></div>'; 
		}
	}
	
	
$backgroundHeight = 'h'.$backgroundHeight;


print "Cache-Control: must-revalidate\n\n";

print qq~
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>$PageTitle</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<script language="javascript" type="text/javascript" src="/cross_browser_javascripts/javascript-library-jquery-1.4.2.min.js"></script>
<script language="javascript" type="text/javascript" src="/cross_browser_javascripts/javascript-jquery-extension_bubblepopup.v2.3.1.min.js"></script>
<script language="javascript" type="text/javascript" src="/cross_browser_javascripts/javascript-yui-extension-container_core-min.js"></script>
<script language="javascript" type="text/javascript" src="/cross_browser_javascripts/javascript-yui-extension_connection-min.js"></script>
<script language="javascript" type="text/javascript" src="/interface_design_templater.php?q=1&p=CHS"></script>
<script language="javascript" type="text/javascript" src="/interface_design_templater.php?q=1&p=FCHS"></script>
<script language="Javascript" type="text/javascript">
<!--
/*var fOb=function(c){var e=c;e.style.background="#FFFFFF";};var bMe=function(c){var e=c;e.style.background="#F7F7F7";};*/
$fancyControl

//-->
</script>
<style type="text/css">
	body { background:url(/web_design_imagery/accountModel-background-$backgroundHeight.png); background-position:bottom right; background-attachment: fixed; background-repeat: no-repeat; }
	.welcomeText { font-size:12px; font-family:verdana,arial,helvetica;color:#000000; line-height:16px; padding-top:30px; }
	.feedbackMessage { font-size:12px; font-family:verdana,arial,helvetica;color:#000000; line-height:16px; padding-bottom:10px; padding-top:10px; }
	.commonInput { height:22px; font-size: 10px; font-family:verdana,arial,helvetica; padding: 2px; background-color:#F7F7F7; }
	.commonInput:focus { background-color:#FFFFFF; }
</style>
<link rel="stylesheet" type="text/css" href="/interface_design_templater.php?q=1&p=CHCSS">
</head>
<body bgcolor="#FFFFFF" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onbeforeunload="$onbefore" $loadscript>
~;


if (length($fancyControl) >= 1) { print "</body></html>"; exit; }

print qq~

<script language="Javascript" type="text/javascript">
$dirtyOut
$formChecker
</script>
<form method="post" name="getpass" onSubmit="if (hasClicked == 0) { runClick(document.getpass.SubmitButton,'Processing'); }">
$recft
~;

print qq~
<table width="100%" border="0" cellpadding="0" cellspacing="0">
	<tr>
      	<td align="center" width="100%" valign="middle">

			<!--Start Wrapper1-->
	  		<table align="center" cellpadding="10" cellspacing="0" border="0">
				<tr>
					<td width="100%" align="center" valign="middle">
					<!--End Wrapper1-->

					$cualPrompt






					
								<div id="HTMLoCodeRequest">
									<table width="548" cellpadding="0" cellspacing="0" border="0">
~;

##--default tabindex buttons
$tinC=2;$tinBS=3;$tinBR=4;

if (!$errorKicker && !$passReset && !$emailSent) {
if ($ISRESET == 1) {
$tinBS=$tinBS+2;$tinBR=$tinBR+2;$tinC=$tinC+2;
print qq~
										<tr>
											<td align="right" style="padding-bottom:4px;padding-top:8px;padding-right:18px;" class="vFormTitle"><b><font class="commonHelper" title="This form field is required.">*</font> <label for="pDub" id="label_pDub">Password</label></b></td>
											<td rowspan="2" align="center"><div style="background-image:url('/website_design_template_images/verticalDottie.gif');background-repeat:repeat-y;width:1px;height:40px;overflow:hidden;clip:rect(0px 1px 40px 0px);"></div></td>
											<td align="left" style="padding-bottom:4px;padding-top:8px;padding-left:18px;" class="vFormTitle"><b><font class="commonHelper" title="This form field is required.">*</font> <label for="pDub2" id="label_pDub2">Re-Type Password</label></b></td>
										</tr>
										<tr>
											<td align="right" style="padding-bottom:14px;padding-right:18px;"><input type="password" name="pDub" id="pDub" value="" maxlength="12" size="25" tabIndex="1" class="commonInput" style="width:206px;" onFocus="formLabelFlipper(this,1);" onBlur="formLabelFlipper(this,0);"></td>
											<td align="left" style="padding-bottom:14px;padding-left:18px;"><input type="password" name="pDub2" id="pDub2" value="" maxlength="12" size="25" tabIndex="2" class="commonInput" style="width:206px;" onFocus="formLabelFlipper(this,1);" onBlur="formLabelFlipper(this,0);"></td>
										</tr>
~;
}
else {
if (!$Username) { $Username = ""; }
print qq~
										<tr>
											<td align="right" style="padding-bottom:4px;padding-top:8px;padding-right:18px;" class="vFormTitle"><b><font class="commonHelper" title="This form field is required.">*</font> <label for="uNaim" id="label_uNaim">Username</label></b></td>
											<td rowspan="2" align="center"><div style="background-image:url('/website_design_template_images/verticalDottie.gif');background-repeat:repeat-y;width:1px;height:40px;overflow:hidden;clip:rect(0px 1px 40px 0px);"></div></td>
											<td rowspan="2" align="left" valign="top" style="padding-top:15px;padding-left:18px;" class="vFormTitle"><a href="javascript:if(!(!parent.runFancyFancy)){parent.runFancyFancy('/forgot-my-username.htm','Virtual Private',580,370);}else{document.location.href='/forgot-my-username.htm';}" title="Can't recall your username, click now have us remind you." class="commonHelper">Did you forget your username?</a><br><i style="font-size:10px;">Don't worry, we've got you covered.</i></td>
										</tr>
										<tr>
											<td align="right" style="padding-bottom:14px;padding-right:18px;"><input type="text" name="uNaim" id="uNaim" value="$Username" maxlength="12" size="25" tabIndex="1" class="commonInput" style="width:206px;" onFocus="formLabelFlipper(this,1);" onBlur="formLabelFlipper(this,0);"></td>
										</tr>
~;
}



if ($emailSent || $passReset) {
print qq~
										<tr>
											<td colspan="3" align="center"><div style="background-image:url('/website_design_template_images/horizontalDottie.gif');background-repeat:repeat-x;width:400px;height:1px;overflow:hidden;clip:rect(0px 400px 1px 0px);"></div></td></tr>
										</tr>
										<tr>
											<td colspan="3" align="center" style="padding-bottom:4px;padding-top:8px;" class="vFormTitle"><input type="button" name="CancelButton" tabIndex="$tinBR" value="Return to Login Screen" onClick="javascript:runClick(this,'Loading');"></td>
										</tr>
~;
}
										

print qq~
										<tr>
											<td colspan="3" align="center"><div style="background-image:url('/website_design_template_images/horizontalDottie.gif');background-repeat:repeat-x;width:400px;height:1px;overflow:hidden;clip:rect(0px 400px 1px 0px);"></div></td></tr>
										</tr>
										<tr>
											<td align="right" valign="top" style="padding-right:14px;padding-top:23px;">
									
												<table width="206" cellpadding="0" cellspacing="0" border="0">
													<tr valign="top">
														<td align="left"><div id="FreeCaptchaChallenge" onClick="freeCaptcha('click');" onMouseOver="freeCaptcha(1);" onMouseOut="freeCaptcha(0);"><img src="/freeCaptcha/?" width="170" id="cFreeCaptcha" class="cFreeCaptcha" name="cFreeCaptcha" border="0"></div></td>
														<td align="center">
														<div style="padding-top:1px;padding-left:1px;padding-right:2px;">
															<div style="padding:1px;border:1px dashed #D5DFE5;">
																<div style="padding:4px;border:1px dashed #D5DFE5;margin-bottom:2px;"><div id="FreeCaptchaReChallenge" onClick="freeCaptcha('click');" onMouseOver="freeCaptcha(1);" onMouseOut="freeCaptcha(0);"><img src="/web_design_imagery/rFreeCaptcha_off.gif" width="20" height="20" id="rFreeCaptcha" name="rFreeCaptcha" class="rFreeCaptcha" border="0" valign="right"></div></div>
																<div style="padding:4px;border:1px dashed #D5DFE5;"><div id="FreeCaptcha-Text-to-Speech" onClick="freeCaptcha('text-to-speech');" onMouseOver="freeCaptcha(3);" onMouseOut="freeCaptcha(2);"><a href="/freeCaptcha/text-to-speech/?" target="FreeCaptchaTTS"><img src="/web_design_imagery/aFreeCaptcha_off.gif" width="20" height="20" id="aFreeCaptcha" name="aFreeCaptcha" class="aFreeCaptcha" border="0" valign="right"></a></div></div>
															</div>
														</div>
														</td>
													</tr>
												</table>

											</td>
											<td align="center"><div style="background-image:url('/website_design_template_images/verticalDottie.gif');background-repeat:repeat-y;width:1px;height:90px;overflow:hidden;clip:rect(0px 1px 90px 0px);"></div></td>
											<td align="left" valign="top" style="padding-left:14px;padding-top:10px;padding-bottom:16px;">
												<table width="206" cellpadding="0" cellspacing="0" border="0">
													<tr><td style="padding-top:10px;padding-bottom:10px;"><div id="FreeCaptchaPromptLabel"><input type="hidden" name="Challenger" value="1"><label for="Challenge" id="label_Challenge" class="FreeCaptchaPromptLabel"><div id="FreeCaptchaPrompt">Type all the characters you see in the challenge code picture to the left.</div></label></div></td></tr>
													<tr><td align="left"><div id="FreeCaptchaInput"><input tabindex="$tinC" class="commonInput" type="text" maxlength="6" name="Challenge" id="Challenge" value="" style="width:206px;" onFocus="formLabelFlipper(this,1);" onBlur="formLabelFlipper(this,0);"></div></td></tr>
													<tr><td style="padding-top:2px;"><div id="FreeCaptchaInfo">Letters are not case-sensitive</div></td></tr>
												</table>											
											</td>
										</tr>





										<tr>
											<td colspan="3" align="center"><div style="background-image:url('/website_design_template_images/horizontalDottie.gif');background-repeat:repeat-x;width:400px;height:1px;overflow:hidden;clip:rect(0px 400px 1px 0px);"></div></td></tr>
										</tr>
										<tr>
											<td align="right" style="padding-bottom:4px;padding-top:8px;padding-right:18px;" class="vFormTitle"><input type="submit" name="SubmitButton" id="SubmitButton" tabIndex="$tinBS" value="$submitTitle"></td>
											<td align="center"><div style="background-image:url('/website_design_template_images/verticalDottie.gif');background-repeat:repeat-y;width:1px;height:20px;overflow:hidden;clip:rect(0px 1px 20px 0px);"></div></td>
											<td align="left" style="padding-bottom:4px;padding-top:8px;padding-left:18px;" class="vFormTitle"><input type="button" name="CancelButton" id="CancelButton" tabIndex="$tinBR" value="Cancel" onClick="javascript:runClick(this,'Canceling');"></td>
										</tr>
~;
}
										
if ($emailSent || $passReset) {
print qq~
<script language="javascript" type="text/javascript">
$runClick
</script>
										<tr>
											<td colspan="3" align="center"><div style="background-image:url('/website_design_template_images/horizontalDottie.gif');background-repeat:repeat-x;width:400px;height:1px;overflow:hidden;clip:rect(0px 400px 1px 0px);"></div></td></tr>
										</tr>
										<tr>
											<td colspan="3" align="center" style="padding-bottom:4px;padding-top:8px;" class="vFormTitle"><input type="button" name="CancelButton" tabIndex="$tinBR" value="Back to Login" onClick="javascript:runClick(this,'Loading');"></td>
										</tr>
~;
}

print qq~

									</table>
								</div>										













<!--Start Wrapper2-->
		</td>
	  </tr>
	  </table>
<!--End Wrapper2-->

    </td>
      <td width="25%">&nbsp;</td>
  </tr>
</table>
</form>
</body>
<script language="javascript" type="text/javascript">
/* wikiboard title object */
if (!(!parent.document.getElementById("WikiBoardBarTitle"))) { 
	mwbt = parent.document.getElementById("WikiBoardBarTitle");
	mwbh = parent.document.getElementById("WikiBoardBarHistory");
	fbsl = parent.document.getElementById("WikiPeeksSlider");
	wbct = parent.document.getElementById("Wiki-Peeks-Content-Source");
	wbcs = parent.document.getElementById("Wiki-Peeks-Content-Search");
}
else if (!(!document.getElementById("WikiBoardBarTitle"))) { 
	mwbt = document.getElementById("WikiBoardBarTitle");
	mwbh = document.getElementById("WikiBoardBarHistory");
	fbsl = document.getElementById("WikiPeeksSlider");
	wbct = document.getElementById("Wiki-Peeks-Content-Source");
	wbcs = document.getElementById("Wiki-Peeks-Content-Search");
}
else { mwbt = 0; wbct = 0; }
var doUnload = function() {
	if (wbct!=0) {
		wbct.innerHTML = '<span style="position:relative;top:2px;left:0px;" title="Loading, please wait..."><img src="/web_design_imagery/loadCircle.gif" width="18" height="15" border="0" alt="Loading, please wait..."></span>';
	}
};
// only if we exist in a framed document from our controlling parent
if (mwbt!=0) {
	// wikiboard content title [source]
	wbct.innerHTML = '<span style="font-weight:normal;position:relative;left:-4px;top:0px;">- $PageTitle</span>';
	// wikiboard content search
	wbcs.innerHTML = '';
}
</script>
</html>

~;

}

exit;
