#!/usr/bin/perl -w

################################################################
#   Program:    Username Reminder Request Form                 #
#   Author:     Luis Gustavo Rodriguez (drlouie)               #
#   Copyright:  (c) 2016 Luis G. Rodriguez                     #
#   Licensing:  MIT License                                    #
##################################################################################
# Permission is hereby granted, free of charge, to any person obtaining a copy   #
# of this software and associated documentation files (the "Software"), to deal  #
# in the Software without restriction, including without limitation the rights   #
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell      #
# copies of the Software, and to permit persons to whom the Software is          #
# furnished to do so, subject to the following conditions:                       #
#                                                                                #
# The above copyright notice and this permission notice shall be included in all #
# copies or substantial portions of the Software.                                #
#                                                                                #
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR     #
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,       #
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE    #
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER         #
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,  #
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  #
# SOFTWARE.                                                                      #
##################################################################################

$perlCompileOS = $^O;
if ($perlCompileOS =~ m/Win/i) {
	$HTTPRoot = 'H:/dvwf/rbsd_IO/vhosts/vsnet/htdocsNEW/';
	$invHTTPRoot = 'H:/dvwf/rbsd_IO/vhosts/vsnet/invisibleHTTP/';
}
else {
	$HTTPRoot = '/var/www/vps-net.com/htdocs/';
	$invHTTPRoot = '/var/www/vps-net.com/invisibleHTTP/';
}

$|=1;

$noDateParse = 1;
require($HTTPRoot."dateNewest.nsp");

$ECkey = 'chuiechuie'; ##-> set cookie key for IMVER [only for eyeCaptcha functions]
## --> Snif cookie, if present test for logged in status
require ($HTTPRoot."cookiesnif.nsp");

require($HTTPRoot."q.nsp");

##--power functions
require($HTTPRoot."vfunc.nsp");

#-WAS
#-use Crypt::Tea;
#-IS
use Crypt::Tea_JS;

$PageTitle = "Account Recovery";

#-- 370 262
$backgroundHeight = '370';

$dirtyOut = "";
$dirtyOut2 = "var virtualPrivate=function(){if (!(!parent.runFancyFancy)) { parent.runFancyFancy('/login.htm','Virtual Private',580,260); }else { document.location.href = '/login.htm'; }};setTimeout(virtualPrivate,15000);";
##-simulate input to stimulate output
if ($FORM{'m'} &&($FORM{'m'} eq "1")) { 
	$emailSent = 1;
	$dirtyOut = $dirtyOut2;
}

$fancyControl = "";
$CaptchaFailed = 0;
$errorKicker = '';
$formChecker = '';
$myInformation = '';

$runClick = 'var hasClicked=0;var runClick=function(quien,action){hasClicked=1;quien.value=action;if(!(!document.getuser.SubmitButton)){document.getuser.SubmitButton.disabled=1;}document.getuser.CancelButton.disabled=1;if(action=="Canceling"||action=="Loading"){if(!(!parent.runFancyFancy)){parent.runFancyFancy("/login.htm","Virtual Private",580,260);}else{document.location.href="/login.htm";}}else{document.getuser.submit();}};';

$loadscript = "onLoad=\"document.getuser.em.select();document.getuser.em.focus();\"";

$itemTitle = 'Retrieve Account Username';
$FeedbackMessage = 'Enter your email address to retrieve your username.<br><br>';

## If filled out form
if ($FORM{'em'} && ($FORM{'em'} =~ "\@" && $FORM{'em'} =~ '.')) {

	$CaptchaFailed = 9;
	if ($FORM{'Challenge'}) {
		##-- cleaner way
		$CaptchaFailed = &testCaptcha;
	}


	##-- captcha feedback messages
	if ($CaptchaFailed == 1) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Challenge code was incorrect, please try again: <br><br>'; }
	elsif ($CaptchaFailed == 8) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Challenge code is 6 characters in length, try again: <br><br>'; }
	elsif ($CaptchaFailed == 9) { $FeedbackMessage = '<b style="color:#AF041C">*</b>Challenge code is required, please try again: <br><br>'; }

	$em = "$FORM{'em'}";


	##--must submit challenge code to go into this process point
	if ($CaptchaFailed == 0) {

		$EmailFailed = 1;
		$EmailFailed = &checkEmail;

		if ($EmailFailed == 0) {
		
			$elEmail = $em;
			$elEmail =~ s/@/[at]/g;
			## Define Variables
			## Start DB connection
			use DBI;
			my $dbh = DBI->connect("DBI:mysql:vpsnetcom","vpsnetcom","YOUR-MySQL-PASSWORD") or die "No data access: <b>VPS-NET</b>\n"; 
			$dbh->{RaiseError} = 1; 
			my $sth = $dbh->prepare("SELECT UserID, FirstName, LastName, Email, Username FROM Users WHERE Email = '$elEmail'");
			$sth->execute or die "Sorry, that Username/Password combination are incorrect, try again at your own risk.\n";
				my $row = $sth->fetchrow_arrayref;
				$UserID = $row->[0];
				$First = $row->[1];
				$Last = $row->[2];
				$Email = $row->[3];
				$UserN = $row->[4];
			$sth->finish;	

			if ($UserID && ($UserID > 555)) {
				$laEME = $Email;
				$laEME =~ s/\[at\]/@/g;

				$myInformation = "<b>About This Message</b><br><br>This message was sent to you by Virtual Private Servers and Networks. to remind you of your account username, as per your request.</i>";
				## ----------------------->>> SEND RECIPIENTS'S EMAIL
				## ----------------------->>> PREPARE VARIABLES FOR OUTER SEND EMAIL PROGRAM
				my $OGSenderIn = "Virtual Private - Account Management<admin\@vps-net.com>";
				$elEmailTo = "$laEME";
				if ($First && $Last) {
					if ((length($First) > 2) && (length($Last) > 2)) { $elEmailTo = "$First $Last <$laEME>"; }
				}
				my $OGRecipientIn = $elEmailTo;
				my $OGsubject = "Username Reminder";

				$myEmailBody = &getEmailHTML(2,1,"Virtual Private - $PageTitle","","$OGsubject","This message is to remind you of the username you chose for your <em>Virtual Private Servers and Networks</em> account. Your username for <em title=\"Visit the Virtual Private Servers and Networks website at: www.vps-net.com\">http://www.vps-net.com</em> is: <b>$UserN</b><br><br><br>Considering you now know your username, would you like to log into <a href=\"http://www.vps-net.com/forgot-my-username.htm\" target=\"VPS-NET-COM\" title=\"Visit the Virtual Private Servers and Networks website at: www.vps-net.com\">Virtual Private Servers and Networks</a>?<br><br><br>You now know your username, but what if you <a href=\"http://www.vps-net.com/forgot-my-password.htm\" target=\"VPS-NET-COM\" title=\"If you've forgotten your password, just click this link to return to Virtual Private's website, and we will gladly assist you in retrieving it.\">forgot your password?</a>","<i>* If you didn't request this information to be sent to you please let us know.<br><br></i>");
				
				use lib "/usr/local/lib/";
				use MIME::Lite;
				my $msg = MIME::Lite->new(
									From    =>$OGSenderIn,
				                	To      =>$OGRecipientIn,
   		    	 		        	Subject =>$OGsubject,
				                	Type    =>'multipart/related'
	   	     					);
			   	$msg->attach(Type => 'text/html',
			   	Data => $myEmailBody);
				$msg->send();
				#print "Cache-Control: must-revalidate\n\n";
				#print $myEmailBody;
				#exit;
			}
			#->WAS			
			#->print "Cache-Control: must-revalidate\n\n";print qq~<script language="javascript">alert('If an account exists for the email address you provided, you will receive a message reminding you of your Virtual Private account username.');if(!(!parent.runFancyFancy)){parent.runFancyFancy('/forgot-my-username.htm','Virtual Private',580,260);}else{document.location.href='/forgot-my-username.htm';}</script>~;exit;
			#->alert('If an account exists for $Username, we will send $Username an email message with instructions on resetting the account password.'); 
			$fancyControl = "if (!(!parent.runFancyFancy)) { parent.runFancyFancy('/forgot-my-username.htm?m=1','Virtual Private',580,190); }else { document.location.href = '/forgot-my-username.htm?m=1'; }";
			$emailSent = 1;
		}
	}
}


if ($CaptchaFailed == 0) {
	if ($whyNewTry) {
		$FeedbackMessage = $whyNewTry . "<br><br>";
	}
}


$cualPrompt =  '<div class="welcomeText"><b>'.$itemTitle.'</b></div><div class="feedbackMessage">'.$FeedbackMessage.'</div>'; 



$onbefore = 'doUnload();';
##-- no longer using $emailSent [just using alert instead, fluidity]
if ($fancyControl || $emailSent) {
	$formChecker = '';
	$onbefore = '';
	$loadscript = '';
	if ($emailSent) {
		$kickMessage = "<div style=\"text-align:left;line-height:18px;padding-left:25px;padding-right:25px;\">If an account exists for you, we will send you a username reminder message.</div>";
		#-->$PageTitle = "Password Retrieval Request";
		$cualPrompt =  '<div class="welcomeText"><b>Request Successfully Processed</b></div><div class="feedbackMessage">'.$kickMessage.'</em></div>';
	}
}

$backgroundHeight = 'h'.$backgroundHeight;

print "Cache-Control: must-revalidate\n\n";

print qq~
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>$PageTitle</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<script language="javascript" type="text/javascript" src="/cross_browser_javascripts/javascript-library-jquery-1.4.2.min.js"></script>
<script language="javascript" type="text/javascript" src="/cross_browser_javascripts/javascript-jquery-extension_bubblepopup.v2.3.1.min.js"></script>
<script language="javascript" type="text/javascript" src="/cross_browser_javascripts/javascript-yui-extension-container_core-min.js"></script>
<script language="javascript" type="text/javascript" src="/cross_browser_javascripts/javascript-yui-extension_connection-min.js"></script>
<script language="javascript" type="text/javascript" src="/interface_design_templater.php?q=1&p=CHS"></script>
<script language="javascript" type="text/javascript" src="/interface_design_templater.php?q=1&p=FCHS"></script>
<script language="Javascript" type="text/javascript">
<!--
/*var cFm=function(){var ViRtUaL_="";var pRiVaTe_="";var SeRvErS_ = document.getuser.em;if(SeRvErS_.value==""){ViRtUaL_+="\\n     - Your Email Address is missing";if(pRiVaTe_==""){pRiVaTe_="em";}}else if((SeRvErS_.value.indexOf('\@')==-1)||(SeRvErS_.value.indexOf('.')==-1)){ViRtUaL_+="\\n     - Your Email Address's Format should be: username\@company.com";if(pRiVaTe_==""){pRiVaTe_="em";}}if((SeRvErS_.value.indexOf(',')!=-1)){ViRtUaL_+="\\n     - (,) Commas are not allowed in email addresses";if(pRiVaTe_==""){pRiVaTe_="em";}}if((SeRvErS_.value.indexOf(';')!=-1)){ViRtUaL_+="\\n     - (;) Semicolons are not allowed in email addresses";if(pRiVaTe_==""){pRiVaTe_="em";}}if((SeRvErS_.value.indexOf(':')!=-1)){ViRtUaL_+="\\n     - (:) Colons are not allowed in email addresses";if(pRiVaTe_==""){pRiVaTe_="em";}}if((SeRvErS_.value.indexOf('\&')!=-1)){ViRtUaL_+="\\n     - (\&) Ampersands are not allowed in email addresses";if(pRiVaTe_==""){pRiVaTe_="em";}}if((SeRvErS_.value.indexOf(' ')!=-1)){ViRtUaL_+="\\n     - Spaces are not allowed in email addresses";if(pRiVaTe_==""){pRiVaTe_="em";}}if(ViRtUaL_!=""){ViRtUaL_="___________________________________________                   \\n\\n"+"  Sorry, your request cannot be processed cause the\\n  following fields are either blank or filled incorrectly:\\n"+"___________________________________________                   \\n\\n"+ViRtUaL_+"\\n\\n___________________________________________                   "+"\\n\\n   To continue, check fields and submit form again!"+"\\n___________________________________________";alert(ViRtUaL_);document.getuser[pRiVaTe_].focus();rBc();return false;}else{return true;}}var rBc=function(){if(!(!document.getuser.SubmitButton)){document.getuser.SubmitButton.disabled=0;document.getuser.SubmitButton.value="Retrieve Username";}document.getuser.CancelButton.disabled=0;document.getuser.CancelButton.value="Cancel";};var fOb=function(c){var e=c;e.style.background="#FFFFFF";};var bMe=function(c){var e=c;e.style.background="#F7F7F7";};*/
$runClick
$fancyControl
//-->
</script>
<style type="text/css">
	body { background:url(/web_design_imagery/accountModel-background-$backgroundHeight.png); background-position:bottom right; background-attachment: fixed; background-repeat: no-repeat; }
	.welcomeText { font-size:12px; font-family:verdana,arial,helvetica;color:#000000; line-height:16px; padding-top:30px; }
	.feedbackMessage { font-size:12px; font-family:verdana,arial,helvetica;color:#000000; line-height:16px; padding-bottom:10px; padding-top:10px; }
	.commonInput { height:22px; font-size: 10px; font-family:verdana,arial,helvetica; padding: 2px; background-color:#F7F7F7; }
	.commonInput:focus { background-color:#FFFFFF; }
</style>
<link rel="stylesheet" type="text/css" href="/interface_design_templater.php?q=1&p=CHCSS">
</head>
<body bgcolor="#FFFFFF" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onbeforeunload="$onbefore" $loadscript>
~;


if ($fancyControl) { print "</body></html>"; exit; }

print qq~
<script language="Javascript" type="text/javascript">
$dirtyOut
</script>
<form method="post" name="getuser" onSubmit="if (hasClicked == 0) { runClick(document.getuser.SubmitButton,'Processing'); }">
~;

print qq~
<table width="100%" border="0" cellpadding="0" cellspacing="0">
	<tr>
      	<td align="center" width="100%" valign="middle">

			<!--Start Wrapper1-->
	  		<table align="center" cellpadding="10" cellspacing="0" border="0">
				<tr>
					<td width="100%" align="center" valign="middle">
					<!--End Wrapper1-->

					$cualPrompt






					
								<div id="HTMLoCodeRequest">
									<table width="548" cellpadding="0" cellspacing="0" border="0">
~;

if (!$errorKicker && !$emailSent) {
if (!$em) { $em = ""; }
print qq~
										<tr>
											<td rowspan="2" align="right" valign="top" style="padding-top:15px;padding-right:18px;" class="vFormTitle"><i style="font-size:10px;">Know your username, but </i><br><a href="javascript:if(!(!parent.runFancyFancy)){parent.runFancyFancy('/forgot-my-password.htm','Virtual Private',580,370);}else{document.location.href='/forgot-my-password.htm';}" title="Can't recall your password? Simply click here to have us remind you what it is." class="commonHelper">forgot your password?</a></td>
											<td rowspan="2" align="center"><div style="background-image:url('/website_design_template_images/verticalDottie.gif');background-repeat:repeat-y;width:1px;height:40px;overflow:hidden;clip:rect(0px 1px 40px 0px);"></div></td>
											<td align="left" style="padding-bottom:4px;padding-top:8px;padding-left:18px;" class="vFormTitle"><b><font class="commonHelper" title="This form field is required.">*</font> <label for="em" id="label_em">Email Address</label></b></td>
										</tr>
										<tr>
											<td align="left" style="padding-bottom:14px;padding-left:18px;"><input type="text" name="em" id="em" value="$em" size="25" tabIndex="1" class="commonInput" style="width:206px;" onFocus="formLabelFlipper(this,1);" onBlur="formLabelFlipper(this,0);"></td>
										</tr>
~;


									
if ($emailSent) {
print qq~
										<tr>
											<td colspan="3" align="center"><div style="background-image:url('/website_design_template_images/horizontalDottie.gif');background-repeat:repeat-x;width:400px;height:1px;overflow:hidden;clip:rect(0px 400px 1px 0px);"></div></td></tr>
										</tr>
										<tr>
											<td colspan="3" align="center" style="padding-bottom:4px;padding-top:8px;" class="vFormTitle"><input type="button" name="CancelButton" tabIndex="2" value="Return to Login Screen" onClick="javascript:runClick(this,'Canceling');"></td>
										</tr>
~;
}
										

print qq~
										<tr>
											<td colspan="3" align="center"><div style="background-image:url('/website_design_template_images/horizontalDottie.gif');background-repeat:repeat-x;width:400px;height:1px;overflow:hidden;clip:rect(0px 400px 1px 0px);"></div></td></tr>
										</tr>
										<tr>
											<td align="right" valign="top" style="padding-right:14px;padding-top:23px;">
									
												<table width="206" cellpadding="0" cellspacing="0" border="0">
													<tr valign="top">
														<td align="left"><div id="FreeCaptchaChallenge" onClick="freeCaptcha('click');" onMouseOver="freeCaptcha(1);" onMouseOut="freeCaptcha(0);"><img src="/freeCaptcha/?" width="170" id="cFreeCaptcha" class="cFreeCaptcha" name="cFreeCaptcha" border="0"></div></td>
														<td align="center">
														<div style="padding-top:1px;padding-left:1px;padding-right:2px;">
															<div style="padding:1px;border:1px dashed #D5DFE5;">
																<div style="padding:4px;border:1px dashed #D5DFE5;margin-bottom:2px;"><div id="FreeCaptchaReChallenge" onClick="freeCaptcha('click');" onMouseOver="freeCaptcha(1);" onMouseOut="freeCaptcha(0);"><img src="/web_design_imagery/rFreeCaptcha_off.gif" width="20" height="20" id="rFreeCaptcha" name="rFreeCaptcha" class="rFreeCaptcha" border="0" valign="right"></div></div>
																<div style="padding:4px;border:1px dashed #D5DFE5;"><div id="FreeCaptcha-Text-to-Speech" onClick="freeCaptcha('text-to-speech');" onMouseOver="freeCaptcha(3);" onMouseOut="freeCaptcha(2);"><a href="/freeCaptcha/text-to-speech/?" target="FreeCaptchaTTS"><img src="/web_design_imagery/aFreeCaptcha_off.gif" width="20" height="20" id="aFreeCaptcha" name="aFreeCaptcha" class="aFreeCaptcha" border="0" valign="right"></a></div></div>
															</div>
														</div>
														</td>
													</tr>
												</table>

											</td>
											<td align="center"><div style="background-image:url('/website_design_template_images/verticalDottie.gif');background-repeat:repeat-y;width:1px;height:90px;overflow:hidden;clip:rect(0px 1px 90px 0px);"></div></td>
											<td align="left" valign="top" style="padding-left:14px;padding-top:10px;padding-bottom:16px;">
												<table width="206" cellpadding="0" cellspacing="0" border="0">
													<tr><td style="padding-top:10px;padding-bottom:10px;"><div id="FreeCaptchaPromptLabel"><input type="hidden" name="Challenger" value="1"><label for="Challenge" id="label_Challenge" class="FreeCaptchaPromptLabel"><div id="FreeCaptchaPrompt">Type all the characters you see in the challenge code picture to the left.</div></label></div></td></tr>
													<tr><td align="left"><div id="FreeCaptchaInput"><input tabindex="2" class="commonInput" type="text" maxlength="6" name="Challenge" id="Challenge" value="" style="width:206px;" onFocus="formLabelFlipper(this,1);" onBlur="formLabelFlipper(this,0);"></div></td></tr>
													<tr><td style="padding-top:2px;"><div id="FreeCaptchaInfo">Letters are not case-sensitive</div></td></tr>
												</table>											
											</td>
										</tr>





										<tr>
											<td colspan="3" align="center"><div style="background-image:url('/website_design_template_images/horizontalDottie.gif');background-repeat:repeat-x;width:400px;height:1px;overflow:hidden;clip:rect(0px 400px 1px 0px);"></div></td></tr>
										</tr>
										<tr>
											<td align="right" style="padding-bottom:4px;padding-top:8px;padding-right:18px;" class="vFormTitle"><input type="submit" name="SubmitButton" tabIndex="3" value="Retrieve Username"></td>
											<td align="center"><div style="background-image:url('/website_design_template_images/verticalDottie.gif');background-repeat:repeat-y;width:1px;height:20px;overflow:hidden;clip:rect(0px 1px 20px 0px);"></div></td>
											<td align="left" style="padding-bottom:4px;padding-top:8px;padding-left:18px;" class="vFormTitle"><input type="button" name="CancelButton" tabIndex="4" value="Cancel" onClick="javascript:runClick(this,'Canceling');"></td>
										</tr>
~;
}
										
if ($emailSent) {
print qq~
<script language="javascript" type="text/javascript">
$runClick
</script>
										<tr>
											<td colspan="3" align="center"><div style="background-image:url('/website_design_template_images/horizontalDottie.gif');background-repeat:repeat-x;width:400px;height:1px;overflow:hidden;clip:rect(0px 400px 1px 0px);"></div></td></tr>
										</tr>
										<tr>
											<td colspan="3" align="center" style="padding-bottom:4px;padding-top:8px;" class="vFormTitle"><input type="button" name="CancelButton" tabIndex="5" value="Back to Login" onClick="javascript:runClick(this,'Loading');"></td>
										</tr>
~;
}

print qq~

									</table>
								</div>										













<!--Start Wrapper2-->
		</td>
	  </tr>
	  </table>
<!--End Wrapper2-->

    </td>
      <td width="25%">&nbsp;</td>
  </tr>
</table>
</form>
</body>
<script language="javascript" type="text/javascript">
/* wikiboard title object */
if (!(!parent.document.getElementById("WikiBoardBarTitle"))) { 
	mwbt = parent.document.getElementById("WikiBoardBarTitle");
	mwbh = parent.document.getElementById("WikiBoardBarHistory");
	fbsl = parent.document.getElementById("WikiPeeksSlider");
	wbct = parent.document.getElementById("Wiki-Peeks-Content-Source");
	wbcs = parent.document.getElementById("Wiki-Peeks-Content-Search");
}
else if (!(!document.getElementById("WikiBoardBarTitle"))) { 
	mwbt = document.getElementById("WikiBoardBarTitle");
	mwbh = document.getElementById("WikiBoardBarHistory");
	fbsl = document.getElementById("WikiPeeksSlider");
	wbct = document.getElementById("Wiki-Peeks-Content-Source");
	wbcs = document.getElementById("Wiki-Peeks-Content-Search");
}
else { mwbt = 0; wbct = 0; }
var doUnload = function() {
	if (wbct!=0) {
		wbct.innerHTML = '<span style="position:relative;top:2px;left:0px;" title="Loading, please wait..."><img src="/web_design_imagery/loadCircle.gif" width="18" height="15" border="0" alt="Loading, please wait..."></span>';
	}
};
// only if we exist in a framed document from our controlling parent
if (mwbt!=0) {
	// wikiboard content title [source]
	wbct.innerHTML = '<span style="font-weight:normal;position:relative;left:-4px;top:0px;">- $PageTitle</span>';
	// wikiboard content search
	wbcs.innerHTML = '';
}
</script>
</html>

~;


##-- kills warning flags for [used only once: possible typo]
$myGhostWriter = $noDateParse ."". $ECkey;
$myGhostWriter = '';
print $myGhostWriter;


exit;